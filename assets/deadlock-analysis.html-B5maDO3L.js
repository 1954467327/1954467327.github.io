import{_ as s,c as t,a,o as e}from"./app-DYPMFszs.js";const d={};function o(l,n){return e(),t("div",null,[...n[0]||(n[0]=[a(`<h2 id="📋-事故摘要" tabindex="-1"><a class="header-anchor" href="#📋-事故摘要"><span>📋 事故摘要</span></a></h2><table><thead><tr><th>项目</th><th>详情</th></tr></thead><tbody><tr><td><strong>事故编号</strong></td><td>DB-DEADLOCK-20260124-212058</td></tr><tr><td><strong>事故时间</strong></td><td>2026年01月24日 21:20:58 - 21:21:24</td></tr><tr><td><strong>事故类型</strong></td><td>数据库死锁与锁等待超时</td></tr><tr><td><strong>影响系统</strong></td><td>主机和备机数据库更新脚本</td></tr><tr><td><strong>严重等级</strong></td><td>P1（严重）</td></tr></tbody></table><h2 id="⚡-事故时间线" tabindex="-1"><a class="header-anchor" href="#⚡-事故时间线"><span>⚡ 事故时间线</span></a></h2><h3 id="关键事件序列" tabindex="-1"><a class="header-anchor" href="#关键事件序列"><span>关键事件序列</span></a></h3><table><thead><tr><th>时间戳</th><th>主机状态</th><th>备机状态</th><th>关键事件</th></tr></thead><tbody><tr><td>21:20:57</td><td>开始执行[68]步骤</td><td>执行[40-67]步骤</td><td>主机启动稍晚于备机</td></tr><tr><td>21:20:58</td><td>[68]步骤完成(141ms)</td><td><strong>正在执行[68]步骤</strong>(864ms)</td><td><strong>执行速度差异出现</strong></td></tr><tr><td>21:20:58</td><td>[80]步骤死锁失败</td><td>[68]步骤继续执行</td><td><strong>死锁发生</strong></td></tr><tr><td>21:20:58</td><td>[81],[82]步骤死锁</td><td>[80]步骤成功(88ms)</td><td>主机连续失败</td></tr><tr><td>21:20:58</td><td>[84]步骤开始创建存储过程</td><td>[81]步骤成功(155ms)</td><td>主机开始长时间操作</td></tr><tr><td>21:21:04</td><td><strong>[85]步骤调用数据复制存储过程中</strong></td><td><strong>[82]步骤锁等待超时</strong></td><td><strong>备机被阻塞</strong></td></tr><tr><td>21:21:24</td><td>[85]步骤完成(25.61s)</td><td>后续步骤继续执行</td><td>主机恢复</td></tr></tbody></table><h2 id="🔍-根本原因分析" tabindex="-1"><a class="header-anchor" href="#🔍-根本原因分析"><span>🔍 根本原因分析</span></a></h2><h3 id="_1-直接原因-mdl锁竞争" tabindex="-1"><a class="header-anchor" href="#_1-直接原因-mdl锁竞争"><span>1. <strong>直接原因：MDL锁竞争</strong></span></a></h3><p><strong>冲突操作对比：</strong></p><table><thead><tr><th>操作节点</th><th>操作内容</th><th>执行时间</th><th>锁需求</th></tr></thead><tbody><tr><td><strong>备机[68]</strong></td><td><code>ALTER TABLE tbl_organization ALTER COLUMN iroletype SET DEFAULT 1</code></td><td>864ms</td><td>MDL写锁</td></tr><tr><td><strong>主机[80]</strong></td><td><code>call add_index_if_not_exists(&#39;tbl_organization&#39;, ...)</code></td><td>死锁立即失败</td><td>MDL写锁</td></tr></tbody></table><h3 id="_2-具体锁等待触发过程" tabindex="-1"><a class="header-anchor" href="#_2-具体锁等待触发过程"><span>2. 具体锁等待触发过程</span></a></h3><table><thead><tr><th>阶段</th><th>时间范围</th><th>主机操作</th><th>备机操作</th><th>锁冲突详情</th></tr></thead><tbody><tr><td><strong>阶段1：锁等待开始</strong></td><td>21:20:58</td><td><code>call copy_organization()</code>开始</td><td><code>ALTER TABLE tbl_organization...</code>执行中</td><td>主机需要读取表数据</td></tr><tr><td><strong>阶段2：数据锁持有</strong></td><td>21:20:58-21:21:24</td><td><code>INSERT INTO tbl_p6_alarmconnector SELECT * FROM tbl_alarmconnector</code></td><td>准备执行DDL</td><td>主机持有了tbl_alarmconnector的数据读锁</td></tr><tr><td><strong>阶段3：MDL锁请求</strong></td><td>21:20:59</td><td>数据复制持续进行</td><td><code>call add_column(&#39;tbl_alarmconnector&#39;, ...)</code></td><td>备机需要MDL写锁修改表结构</td></tr><tr><td><strong>阶段4：单向等待</strong></td><td>21:20:59-21:21:04</td><td>持续持有数据锁</td><td>等待MDL写锁</td><td>MDL写锁请求被数据读锁阻塞</td></tr><tr><td><strong>阶段5：超时触发</strong></td><td>21:21:04</td><td>数据锁仍持有</td><td>等待超时5.01秒</td><td><code>Lock wait timeout exceeded</code></td></tr></tbody></table><h3 id="_3-死锁形成机制" tabindex="-1"><a class="header-anchor" href="#_3-死锁形成机制"><span>3. <strong>死锁形成机制</strong></span></a></h3><h4 id="第一阶段-锁资源竞争-21-20-58" tabindex="-1"><a class="header-anchor" href="#第一阶段-锁资源竞争-21-20-58"><span>第一阶段：锁资源竞争（21:20:58）</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">备机：持有 tbl_organization 表的MDL写锁（执行[68]步骤，864ms）</span>
<span class="line">主机：需要获取 tbl_organization 表的MDL写锁（执行[80]步骤创建索引）</span>
<span class="line">      ↓</span>
<span class="line">主机：等待备机释放MDL写锁</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第二阶段-循环等待形成" tabindex="-1"><a class="header-anchor" href="#第二阶段-循环等待形成"><span>第二阶段：循环等待形成</span></a></h4><p>主机在等待MDL锁的同时，脚本继续执行了[85]步骤：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">call</span> copy_organization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 耗时25.61秒</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>该操作持有了<code>tbl_organization</code>表的数据读锁，形成了循环等待：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">主机：持有数据读锁 → 等待MDL写锁（用于创建索引）</span>
<span class="line">备机：持有MDL写锁 → 完成后可能需要数据锁（用于后续DDL操作）</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-存储过程执行分析" tabindex="-1"><a class="header-anchor" href="#_4-存储过程执行分析"><span>4. <strong>存储过程执行分析</strong></span></a></h3><h4 id="add-index-if-not-exists-存储过程锁获取顺序" tabindex="-1"><a class="header-anchor" href="#add-index-if-not-exists-存储过程锁获取顺序"><span><code>add_index_if_not_exists</code> 存储过程锁获取顺序：</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token comment">-- 第一步：查询INFORMATION_SCHEMA.STATISTICS（需要MDL读锁）</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> INFORMATION_SCHEMA<span class="token punctuation">.</span><span class="token keyword">STATISTICS</span></span>
<span class="line"><span class="token keyword">WHERE</span> LOWER<span class="token punctuation">(</span>TABLE_NAME<span class="token punctuation">)</span> <span class="token operator">=</span> LOWER<span class="token punctuation">(</span><span class="token string">&#39;tbl_organization&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">AND</span> LOWER<span class="token punctuation">(</span>INDEX_NAME<span class="token punctuation">)</span> <span class="token operator">=</span> LOWER<span class="token punctuation">(</span><span class="token string">&#39;idx_tbl_organization_uiddomainid&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 第二步：执行ALTER TABLE ADD INDEX（需要MDL写锁）</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token variable">@indexsql</span> <span class="token operator">=</span> <span class="token string">&#39;alter table tbl_organization add index ...&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">PREPARE</span> stmtindex <span class="token keyword">FROM</span> <span class="token variable">@indexsql</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">EXECUTE</span> stmtindex<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token comment">/** 需要读锁执行时间25s */</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> tbl_p6_organization <span class="token operator">like</span> tbl_organization <span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> tbl_p6_alarmconnector <span class="token operator">like</span> tbl_alarmconnector<span class="token punctuation">;</span></span>
<span class="line">          <span class="token comment">/** 复制组织架构数据到p6 */</span></span>
<span class="line">          <span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> copy_organization<span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> copy_organization<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">          <span class="token keyword">begin</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> tbl_p6_organization <span class="token keyword">where</span> uidroleid<span class="token operator">=</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">          <span class="token keyword">insert</span> <span class="token keyword">into</span> tbl_p6_organization <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_organization<span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">insert</span> <span class="token keyword">into</span> tbl_p6_alarmconnector <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tbl_alarmconnector<span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="📊-错误类型对比分析" tabindex="-1"><a class="header-anchor" href="#📊-错误类型对比分析"><span>📊 错误类型对比分析</span></a></h2><table><thead><tr><th>特性</th><th>主机（死锁）</th><th>备机（锁等待超时）</th></tr></thead><tbody><tr><td><strong>错误信息</strong></td><td><code>Deadlock found when trying to get lock</code></td><td><code>Lock wait timeout exceeded</code></td></tr><tr><td><strong>发生步骤</strong></td><td>[80],[81],[82]创建索引和添加列</td><td>[82]添加列操作</td></tr><tr><td><strong>响应机制</strong></td><td>数据库主动检测并立即回滚</td><td>等待超时后强制回滚</td></tr><tr><td><strong>等待时间</strong></td><td>立即失败（毫秒级）</td><td>等待5.01秒后超时</td></tr><tr><td><strong>根本原因</strong></td><td>循环等待资源</td><td>单向等待资源释放</td></tr></tbody></table><h1 id="" tabindex="-1"><a class="header-anchor" href="#"><span></span></a></h1>`,26)])])}const i=s(d,[["render",o]]),p=JSON.parse('{"path":"/posts/deadlock-analysis.html","title":"数据库死锁与锁等待超时事故分析报告","lang":"zh-CN","frontmatter":{"lang":"zh-CN","title":"数据库死锁与锁等待超时事故分析报告","description":"数据库死锁与锁等待超时","date":"2026-01-24T00:00:00.000Z","category":["生产问题"],"tag":["数据库","死锁","锁等待"]},"headers":[{"level":2,"title":"📋 事故摘要","slug":"📋-事故摘要","link":"#📋-事故摘要","children":[]},{"level":2,"title":"⚡ 事故时间线","slug":"⚡-事故时间线","link":"#⚡-事故时间线","children":[{"level":3,"title":"关键事件序列","slug":"关键事件序列","link":"#关键事件序列","children":[]}]},{"level":2,"title":"🔍 根本原因分析","slug":"🔍-根本原因分析","link":"#🔍-根本原因分析","children":[{"level":3,"title":"1. 直接原因：MDL锁竞争","slug":"_1-直接原因-mdl锁竞争","link":"#_1-直接原因-mdl锁竞争","children":[]},{"level":3,"title":"2. 具体锁等待触发过程","slug":"_2-具体锁等待触发过程","link":"#_2-具体锁等待触发过程","children":[]},{"level":3,"title":"3. 死锁形成机制","slug":"_3-死锁形成机制","link":"#_3-死锁形成机制","children":[]},{"level":3,"title":"4. 存储过程执行分析","slug":"_4-存储过程执行分析","link":"#_4-存储过程执行分析","children":[]}]},{"level":2,"title":"📊 错误类型对比分析","slug":"📊-错误类型对比分析","link":"#📊-错误类型对比分析","children":[]}],"git":{"updatedTime":1769479858000,"contributors":[{"name":"litong","username":"litong","email":"litong@leagsoft.com","commits":1,"url":"https://github.com/litong"}],"changelog":[{"hash":"969dd8a9faa51bd861130739237919e4c2ae7176","time":1769479858000,"email":"litong@leagsoft.com","author":"litong","message":"新增：更新事故分析报告"}]},"filePathRelative":"posts/deadlock-analysis.md","excerpt":"<h2>📋 事故摘要</h2>\\n<table>\\n<thead>\\n<tr>\\n<th>项目</th>\\n<th>详情</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td><strong>事故编号</strong></td>\\n<td>DB-DEADLOCK-20260124-212058</td>\\n</tr>\\n<tr>\\n<td><strong>事故时间</strong></td>\\n<td>2026年01月24日 21:20:58 - 21:21:24</td>\\n</tr>\\n<tr>\\n<td><strong>事故类型</strong></td>\\n<td>数据库死锁与锁等待超时</td>\\n</tr>\\n<tr>\\n<td><strong>影响系统</strong></td>\\n<td>主机和备机数据库更新脚本</td>\\n</tr>\\n<tr>\\n<td><strong>严重等级</strong></td>\\n<td>P1（严重）</td>\\n</tr>\\n</tbody>\\n</table>"}');export{i as comp,p as data};
